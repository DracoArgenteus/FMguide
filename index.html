<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Folkem√∏det 2025 - Event Index</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FullCalendar v6 Core CSS and JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    
    <style>
        :root {
            --fc-border-color: #e5e7eb; /* gray-200 */
            --fc-daygrid-event-dot-width: 8px;
            --fc-list-event-dot-width: 10px;
        }
        .dark {
             --fc-border-color: #4b5563; /* gray-600 */
             --fc-page-bg-color: #1f2937; /* gray-800 */
             --fc-daygrid-day-bg-color: #1f2937;
             --fc-timegrid-slot-lane-color: #1f2937;
        }
        .dark .fc .fc-toolbar-title { color: #f9fafb; }
        .dark .fc .fc-daygrid-day-number { color: #d1d5db; }
        .dark .fc .fc-col-header-cell-cushion { color: #e5e7eb; }
        .dark .fc .fc-timegrid-axis-cushion { color: #d1d5db; }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans">

    <!-- Modals (Login, Event Details) -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-center">Login</h2>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="loginEmail" class="block text-sm font-medium mb-2">Email Address</label>
                    <input type="email" id="loginEmail" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700" required>
                </div>
                <div class="mb-6">
                    <label for="loginPassword" class="block text-sm font-medium mb-2">Password</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">Login</button>
            </form>
            <p id="loginError" class="text-red-500 text-sm mt-4 text-center hidden"></p>
            <button id="closeLoginModal" class="absolute top-4 right-4 text-2xl text-gray-500 hover:text-gray-800 dark:hover:text-gray-200">&times;</button>
        </div>
    </div>

    <div id="eventDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-lg">
            <h2 id="eventDetailTitle" class="text-2xl font-bold mb-2"></h2>
            <p id="eventDetailTime" class="text-gray-600 dark:text-gray-400 mb-4"></p>
            <p id="eventDetailLocation" class="text-gray-600 dark:text-gray-400 mb-4"></p>
            <h3 class="text-lg font-semibold mb-2">Attendees:</h3>
            <ul id="eventDetailAttendees" class="list-disc list-inside mb-6"></ul>
            <div class="flex gap-4">
                <button id="eventDetailSignupButton" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg"></button>
            </div>
            <button id="closeEventDetailModal" class="absolute top-4 right-4 text-2xl">&times;</button>
        </div>
    </div>

    <!-- Main Application UI -->
    <div class="container mx-auto p-4 md:p-8">
        <header class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200 dark:border-gray-700">
            <h1 class="text-3xl font-bold">Folkem√∏det Event Index</h1>
            <div class="flex items-center space-x-4">
                <span id="userDisplay" class="hidden font-medium"></span>
                <button id="loginNavButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Login</button>
                <button id="logoutButton" class="hidden bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Logout</button>
            </div>
        </header>

        <main id="mainContent" class="hidden">
            <div id='calendar'></div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            
            const firebaseConfig = {
                apiKey: "AIzaSyAwNsvDxANT6VKgWRl7bOu4FkTkmahKoss",
                authDomain: "fm-app-c58ab.firebaseapp.com",
                projectId: "fm-app-c58ab",
                storageBucket: "fm-app-c58ab.appspot.com",
                messagingSenderId: "640978558377",
                appId: "1:640978558377:web:055e05ac645d49904d38b8",
                measurementId: "G-9GBEZCE9NG"
            };

            // --- Firebase & FullCalendar Initialization ---
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            let calendar = null; // To hold the FullCalendar instance

            // --- DOM Element References ---
            const mainContent = document.getElementById('mainContent');
            const userDisplay = document.getElementById('userDisplay');
            const loginNavButton = document.getElementById('loginNavButton');
            const logoutButton = document.getElementById('logoutButton');
            // Modal elements
            const loginModal = document.getElementById('loginModal');
            const loginForm = document.getElementById('loginForm');
            const eventDetailModal = document.getElementById('eventDetailModal');

            // --- Global State ---
            let currentUserId = null;
            let currentUserEmail = null;

            // --- Initial Setup ---
            function initializeCalendar() {
                const calendarEl = document.getElementById('calendar');
                calendar = new FullCalendar.Calendar(calendarEl, {
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    initialView: 'timeGridWeek',
                    editable: false, 
                    selectable: false,
                    eventDidMount: function(info) {
                        // Display number of attendees on the event
                        const attendeesCount = info.event.extendedProps.attendees?.length || 0;
                        const attendeeSpan = document.createElement('span');
                        attendeeSpan.innerHTML = `üë• ${attendeesCount}`;
                        attendeeSpan.className = 'ml-2';
                        info.el.querySelector('.fc-event-title').appendChild(attendeeSpan);
                    },
                    eventClick: function(info) {
                        showEventDetails(info.event);
                    }
                });
                calendar.render();
                setupFirestoreListeners();
            }

            // --- Firestore Real-time Listeners ---
            function setupFirestoreListeners() {
                 let allEvents = [];
                 let allSignups = {};

                 onSnapshot(collection(db, "events"), (eventsSnapshot) => {
                    allEvents = eventsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateCalendarEvents(allEvents, allSignups);
                 });

                 onSnapshot(collection(db, "signups"), (signupsSnapshot) => {
                    allSignups = {};
                    signupsSnapshot.forEach(doc => {
                        const signup = doc.data();
                        if (!allSignups[signup.eventId]) {
                            allSignups[signup.eventId] = [];
                        }
                        allSignups[signup.eventId].push({ userId: signup.userId, userEmail: signup.userEmail });
                    });
                    updateCalendarEvents(allEvents, allSignups);
                 });
            }

            function updateCalendarEvents(events, signups) {
                if (!calendar) return;

                const calendarEvents = events.map(event => {
                    const attendees = signups[event.id] || [];
                    const isUserSignedUp = attendees.some(a => a.userId === currentUserId);

                    return {
                        id: event.id,
                        title: event.EventTitle,
                        start: new Date(event.Timestamp.seconds * 1000),
                        // Assuming 1 hour duration if no end time is provided
                        end: event.EndTime ? new Date(event.EndTime.seconds * 1000) : new Date((event.Timestamp.seconds + 3600) * 1000),
                        extendedProps: {
                            location: event.Location,
                            attendees: attendees,
                            isUserSignedUp: isUserSignedUp
                        },
                        // Visually distinguish user's events
                        backgroundColor: isUserSignedUp ? '#10B981' : '#3B82F6', // Green if signed up, Blue otherwise
                        borderColor: isUserSignedUp ? '#059669' : '#2563EB',
                    };
                });
                
                calendar.getEvents().forEach(event => event.remove());
                calendar.addEventSource(calendarEvents);
            }

            // --- Authentication Logic ---
            onAuthStateChanged(auth, user => {
                if (user) {
                    currentUserId = user.uid;
                    currentUserEmail = user.email;
                    userDisplay.textContent = currentUserEmail;
                    mainContent.classList.remove('hidden');
                    loginNavButton.classList.add('hidden');
                    logoutButton.classList.remove('hidden');
                    userDisplay.classList.remove('hidden');
                    loginModal.classList.add('hidden');
                    if (!calendar) {
                        initializeCalendar();
                    }
                } else {
                    currentUserId = null;
                    currentUserEmail = null;
                    mainContent.classList.add('hidden');
                    loginNavButton.classList.remove('hidden');
                    logoutButton.classList.add('hidden');
                    userDisplay.classList.add('hidden');
                     if (calendar) {
                        calendar.destroy();
                        calendar = null;
                    }
                }
            });
            
            // --- Modal & Button Logic ---
            function setupModalListeners() {
                // Login Modal
                loginNavButton.addEventListener('click', () => loginModal.classList.remove('hidden'));
                document.getElementById('closeLoginModal').addEventListener('click', () => loginModal.classList.add('hidden'));
                loginForm.addEventListener('submit', async e => {
                    e.preventDefault();
                    document.getElementById('loginError').classList.add('hidden');
                    try {
                        await signInWithEmailAndPassword(auth, loginForm.loginEmail.value, loginForm.loginPassword.value);
                    } catch (error) {
                         document.getElementById('loginError').textContent = "Login failed: " + error.code;
                         document.getElementById('loginError').classList.remove('hidden');
                    }
                });
                logoutButton.addEventListener('click', () => signOut(auth));

                // Event Detail Modal
                document.getElementById('closeEventDetailModal').addEventListener('click', () => eventDetailModal.classList.add('hidden'));
            }

            function showEventDetails(event) {
                document.getElementById('eventDetailTitle').innerText = event.title;
                document.getElementById('eventDetailLocation').innerText = `üìç ${event.extendedProps.location}`;
                document.getElementById('eventDetailTime').innerText = `üóìÔ∏è ${event.start.toLocaleString()}`;

                const attendeesList = document.getElementById('eventDetailAttendees');
                attendeesList.innerHTML = '';
                if (event.extendedProps.attendees.length > 0) {
                    event.extendedProps.attendees.forEach(a => {
                        const li = document.createElement('li');
                        li.innerText = a.userEmail;
                        attendeesList.appendChild(li);
                    });
                } else {
                    attendeesList.innerHTML = '<li>No one has signed up yet.</li>';
                }

                const signupButton = document.getElementById('eventDetailSignupButton');
                if (event.extendedProps.isUserSignedUp) {
                    signupButton.innerText = 'Cancel Signup';
                    signupButton.className = 'flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg';
                } else {
                    signupButton.innerText = 'Sign Up';
                    signupButton.className = 'flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg';
                }

                signupButton.onclick = () => handleSignUp(event.id, event.extendedProps.isUserSignedUp);
                
                eventDetailModal.classList.remove('hidden');
            }
            
            async function handleSignUp(eventId, isCancelling) {
                if (!currentUserId) return;
                const signupDocRef = doc(db, "signups", `${eventId}_${currentUserId}`);
                
                try {
                    if (isCancelling) {
                        await deleteDoc(signupDocRef);
                        console.log("Signup cancelled.");
                    } else {
                        await setDoc(signupDocRef, { 
                            eventId: eventId, 
                            userId: currentUserId, 
                            userEmail: currentUserEmail, 
                            timestamp: new Date() 
                        });
                        console.log("Signed up successfully.");
                    }
                    eventDetailModal.classList.add('hidden'); // Close modal on success
                } catch (error) {
                    console.error("Error handling signup:", error);
                }
            }
            
            setupModalListeners();
        });
    </script>
</body>
</html>
