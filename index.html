<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Folkemødet 2025 - Combined Event Schedule</title>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- MDB -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.2.0/mdb.min.css" rel="stylesheet" />
    <!-- DataTables -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    
    <script type="module">
        // Import the functions you need from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-analytics.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, onSnapshot, setDoc, deleteDoc, writeBatch, getDoc, updateDoc, deleteField, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";
      
        // Your Firebase configuration object
        const firebaseConfig = {
            apiKey: "AIzaSyAwNsvDxANT6VKgWRl7bOu4FkTkmahKoss",
            authDomain: "fm-app-c58ab.firebaseapp.com",
            projectId: "fm-app-c58ab",
            storageBucket: "fm-app-c58ab.firebasestorage.app",
            messagingSenderId: "640978558377",
            appId: "1:640978558377:web:055e05ac645d49904d38b8",
            measurementId: "G-9GBEZCE9NG"
        };

        // Initialize Firebase
        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const analytics = getAnalytics(app);
            window.firebase = { 
                app, auth, db, 
                createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, 
                collection, getDocs, analytics,
                GoogleAuthProvider, signInWithPopup,
                doc, onSnapshot, setDoc, deleteDoc, writeBatch, getDoc, updateDoc, deleteField,
                arrayUnion, arrayRemove
            };
            console.log("Firebase initialized successfully.");
        } catch (e) {
            console.error("Error initializing Firebase:", e);
        }
    </script>
    
    <!-- Custom Color Theme and Styles -->
    <style>
        :root {
            --mdb-primary: #dd0079;
            --mdb-primary-rgb: 221, 0, 121;
        }
        .btn-primary, .btn-check:checked+.btn-primary { background-color: var(--mdb-primary) !important; border-color: var(--mdb-primary) !important; }
        .btn-outline-primary { color: var(--mdb-primary) !important; border-color: var(--mdb-primary) !important; }
        .btn-outline-primary:hover, .btn-check:checked+.btn-outline-primary { color: #fff !important; background-color: var(--mdb-primary) !important; border-color: var(--mdb-primary) !important; }
        a, .text-primary, .page-item.active .page-link { color: var(--mdb-primary) !important; }
        .page-item.active .page-link { background-color: var(--mdb-primary) !important; border-color: var(--mdb-primary) !important; color: #fff !important; }
        .dataTables_info { color: var(--mdb-primary) !important; }
        body { font-family: 'Inter', sans-serif; padding-top: 58px; }
        .invitation-only { background-color: rgba(221, 0, 121, 0.1) !important; }
        html[data-mdb-theme="dark"] .invitation-only { background-color: rgba(221, 0, 121, 0.2) !important; }
        #eventTable tbody tr { cursor: pointer; }
        .favorite-icon { color: var(--mdb-primary); transition: transform 0.2s ease-in-out; }
        .favorite-icon:hover { transform: scale(1.2); }
        .timeline-container { overflow-x: auto; }
        .timeline-day { margin-bottom: 2rem; }
        .timeline-grid { position: relative; min-height: 960px; /* 16 hours * 60px */ }
        .time-label { position: absolute; left: 0; width: 50px; text-align: right; padding-right: 10px; font-size: 0.8em; color: #9e9e9e; }
        .time-line { position: absolute; left: 60px; right: 0; height: 1px; background-color: #eee; }
        html[data-mdb-theme="dark"] .time-line { background-color: #4f4f4f; }
        .timeline-event { position: absolute; left: 65px; background-color: rgba(var(--mdb-primary-rgb), 0.8); color: white; border-left: 3px solid var(--mdb-primary); padding: 5px 8px; border-radius: 4px; font-size: 0.8em; overflow: hidden; z-index: 1; }
        .timeline-event.teammate { background-color: rgba(108, 117, 125, 0.8); border-left-color: #6c757d; }
    </style>
</head>
<body>
    <!-- Auth Modal -->
    <div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="authModalLabel">Login / Sign Up</h5><button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button></div>
                <div class="modal-body">
                    <div data-mdb-input-init class="form-outline mb-4"><input type="email" id="authEmail" class="form-control" /><label class="form-label" for="authEmail">Email address</label></div>
                    <div data-mdb-input-init class="form-outline mb-4"><input type="password" id="authPassword" class="form-control" /><label class="form-label" for="authPassword">Password (min. 6 characters)</label></div>
                    <p id="authError" class="text-danger small mb-3" style="display: none;"></p>
                    <div class="d-flex justify-content-end mb-3"><button id="authSignUpButton" type="button" data-mdb-button-init data-mdb-ripple-init class="btn btn-light me-2">Sign Up</button><button id="authLoginButton" type="button" data-mdb-button-init data-mdb-ripple-init class="btn btn-primary">Login</button></div>
                    <hr/>
                    <div class="text-center"><button id="googleLoginButton" type="button" data-mdb-button-init data-mdb-ripple-init class="btn btn-primary btn-block"><i class="fab fa-google me-2"></i>Continue with Google</button></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Teams Modal -->
    <div class="modal fade" id="teamsModal" tabindex="-1" aria-labelledby="teamsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="teamsModalLabel">My Team</h5><button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button></div>
                <div class="modal-body">
                    <div id="team-info-view">
                        <p>Your Team ID: <strong id="current-team-id" class="text-primary"></strong> <button id="copy-team-id" class="btn btn-sm btn-light py-1 px-2 ms-2"><i class="far fa-copy"></i></button></p>
                        <h6>Team Members:</h6>
                        <ul id="team-members-list" class="list-group list-group-light mb-3"></ul>
                        <button id="leave-team-button" class="btn btn-danger btn-block">Leave Team</button>
                    </div>
                    <div id="no-team-view">
                        <p>You are not currently in a team.</p>
                        <hr/>
                        <h6>Join a Team</h6>
                        <div class="input-group mb-3">
                            <input type="text" id="join-team-id-input" class="form-control" placeholder="Enter Team ID"/>
                            <button id="join-team-button" class="btn btn-primary">Join</button>
                        </div>
                        <p id="join-team-error" class="text-danger small" style="display:none;"></p>
                        <h6>Create a Team</h6>
                        <button id="create-team-button" class="btn btn-outline-primary btn-block">Create New Team</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand text-primary" href="#"><strong>Folkemødet 2025</strong></a>
            <button class="navbar-toggler" type="button" data-mdb-collapse-init data-mdb-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation"><i class="fas fa-bars"></i></button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center">
                    <li class="nav-item"><button id="team-button" class="btn btn-outline-primary btn-sm m-1"><i class="fas fa-users me-lg-2"></i><span class="d-lg-none d-xl-inline">My Team</span></button></li>
                    <li class="nav-item"><button id="calendar-button" class="btn btn-outline-primary btn-sm m-1"><i class="far fa-calendar-alt me-lg-2"></i><span class="d-lg-none d-xl-inline">My Calendar</span></button></li>
                    <li class="nav-item"><button id="toggleStatsButton" class="btn btn-outline-primary btn-sm m-1" type="button" data-mdb-collapse-init data-mdb-ripple-init href="#statsSectionContainer"><i class="fas fa-chart-bar me-lg-2"></i><span id="toggleStatsButtonText" class="d-lg-none d-xl-inline">Show Statistics</span></button></li>
                    <li class="nav-item"><button id="theme-toggle" class="btn btn-outline-primary btn-sm m-1"><i class="fas fa-sun"></i><i class="fas fa-moon" style="display: none;"></i></button></li>
                    <li id="login-nav-item" class="nav-item"><button id="login-button" type="button" data-mdb-button-init data-mdb-ripple-init class="btn btn-primary btn-sm m-1">Login</button></li>
                    <li id="user-nav-item" class="nav-item dropdown" style="display: none;">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarDropdown" role="button" data-mdb-dropdown-init aria-expanded="false"><i class="fas fa-user-circle fa-lg me-2"></i> <span id="user-display-name"></span></a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><h6 class="dropdown-header" id="user-status">Signed in as</h6></li>
                            <li><hr class="dropdown-divider" /></li>
                            <li><a class="dropdown-item" href="#" id="logout-button"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content Container -->
    <div class="container mt-4 mb-5">
        <header class="mb-4 text-center"><h1 class="text-primary">Combined Event Schedule</h1><p id="dataFreshness" class="text-muted small">Loading data...</p></header>
        <div class="collapse" id="statsSectionContainer">
            <div class="card mb-4"><div class="card-body"><h3 class="text-primary mb-4 text-center">Filtered Statistics</h3><div class="row text-center"><div class="col-md-3 col-6 mb-4"><h5 class="text-muted">Total Events</h5><p id="stat-total-events" class="h2 mb-0">0</p></div><div class="col-md-3 col-6 mb-4"><h5 class="text-muted">Busiest Hour</h5><p id="stat-busiest-hour" class="h2 mb-0">--:--</p></div><div class="col-md-3 col-6 mb-4"><h5 class="text-muted">Busiest Location</h5><p id="stat-busiest-location" class="h5 mb-0 text-truncate" title="N/A">N/A</p></div><div class="col-md-3 col-6 mb-4"><h5 class="text-muted">Invitation Only</h5><p id="stat-invitation-only" class="h2 mb-0">0</p></div></div><hr/><div class="chart-wrapper mt-4"><h4 class="text-center text-muted mb-3">Events per Hour</h4><canvas id="eventsPerHourChart"></canvas></div></div></div>
        </div>
        <div id="tableErrorMessage" class="alert alert-danger" style="display: none;"></div>
        <div class="card"><div class="card-body"><div class="row mb-4"><div class="col-md-6 mb-3 mb-md-0"><h5 class="mb-2">Filter by Source:</h5><div class="btn-group source-filter-buttons" role="group"><input type="radio" class="btn-check" name="sourceFilter" id="sourceAll" autocomplete="off" data-source="All" checked /><label class="btn btn-outline-primary" for="sourceAll">All</label><input type="radio" class="btn-check" name="sourceFilter" id="sourceOfficial" autocomplete="off" data-source="Official" /><label class="btn btn-outline-primary" for="sourceOfficial">Official</label><input type="radio" class="btn-check" name="sourceFilter" id="sourcePrivate" autocomplete="off" data-source="Private" /><label class="btn btn-outline-primary" for="sourcePrivate">Private</label><input type="radio" class="btn-check" name="sourceFilter" id="sourceSocial" autocomplete="off" data-source="Social" /><label class="btn btn-outline-primary" for="sourceSocial">Social</label></div></div><div class="col-md-6"><h5 class="mb-2">Filter by Day:</h5><div class="btn-group filter-buttons" role="group"><input type="radio" class="btn-check" name="dayFilter" id="dayAll" autocomplete="off" data-day="All" checked /><label class="btn btn-outline-primary" for="dayAll">All</label><input type="radio" class="btn-check" name="dayFilter" id="dayOnsdag" autocomplete="off" data-day="Onsdag" /><label class="btn btn-outline-primary" for="dayOnsdag">Onsdag</label><input type="radio" class="btn-check" name="dayFilter" id="dayTorsdag" autocomplete="off" data-day="Torsdag" /><label class="btn btn-outline-primary" for="dayTorsdag">Torsdag</label><input type="radio" class="btn-check" name="dayFilter" id="dayFredag" autocomplete="off" data-day="Fredag" /><label class="btn btn-outline-primary" for="dayFredag">Fredag</label><input type="radio" class="btn-check" name="dayFilter" id="dayLørdag" autocomplete="off" data-day="Lørdag" /><label class="btn btn-outline-primary" for="dayLørdag">Lørdag</label></div></div></div><div class="table-responsive"><table id="eventTable" class="table table-striped table-hover"><thead></thead><tbody></tbody></table></div></div></div>
        <footer class="mt-5 text-center text-muted small"><p>&copy; <span id="currentYear"></span> Folkemødet Event Viewer.</p></footer>
    </div>
    
    <!-- ***REVERTED*** to single modal with two tabs for simplicity -->
    <div class="modal fade" id="mainModal" tabindex="-1" aria-labelledby="mainModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
          <div class="modal-header">
             <ul class="nav nav-tabs" id="mainModalTabs" role="tablist">
                <li class="nav-item" role="presentation"><a data-mdb-tab-init class="nav-link active" id="tab-details" href="#details-pane" role="tab" aria-controls="details-pane" aria-selected="true">Details</a></li>
                <li class="nav-item" role="presentation"><a data-mdb-tab-init class="nav-link" id="tab-calendar" href="#calendar-pane" role="tab" aria-controls="calendar-pane" aria-selected="false">My Calendar</a></li>
             </ul>
            <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
             <div class="tab-content" id="mainModalContent">
                <div class="tab-pane fade show active" id="details-pane" role="tabpanel" aria-labelledby="tab-details"></div>
                <div class="tab-pane fade" id="calendar-pane" role="tabpanel" aria-labelledby="tab-calendar"></div>
             </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.2.0/mdb.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <script>
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        const ALL_DATA_HEADERS = ["Favorite", "EventTitle", "Weekday", "TimeRange", "Location", "Description", "EventURL", "Organizers", "Theme", "DataSource", "id"];
        
        $(document).ready(function() {
            let eventDataTable = null, mainModalInstance, teamsModalInstance, authModalInstance;
            let allEvents = [], teamFavorites = new Map(), teamMembers = new Map();
            let favoriteEvents = new Set(), currentUserId = null, currentTeamId = null;
            let unsubscribeFavorites = () => {}, unsubscribeUser = () => {}, unsubscribeTeam = () => {};

            // --- DOM ELEMENT GETTERS ---
            const getEl = (id) => document.getElementById(id);
            const detailsPane = getEl('details-pane'), calendarPane = getEl('calendar-pane');
            const mainModalTabs = { details: new mdb.Tab(getEl('tab-details')), calendar: new mdb.Tab(getEl('tab-calendar')) };
            const teamButton = getEl('team-button'), calendarButton = getEl('calendar-button');
            const userDisplayName = getEl('user-display-name'), loginNavItem = getEl('login-nav-item'), userNavItem = getEl('user-nav-item');
            
            // --- MODAL INITIALIZATION ---
            mainModalInstance = new mdb.Modal(getEl('mainModal'));
            teamsModalInstance = new mdb.Modal(getEl('teamsModal'));
            authModalInstance = new mdb.Modal(getEl('authModal'));

            // --- THEME SWITCHER ---
            // ... (no changes)

            // --- FIREBASE AUTH & DATA LOGIC ---
            async function toggleFavorite(eventId, isFavorited) {
                if (!currentUserId || !window.firebase) return;
                const { db, doc, setDoc, deleteDoc, updateDoc, arrayUnion, arrayRemove, getDoc, deleteField } = window.firebase;
                const favDocRef = doc(db, "users", currentUserId, "favorites", eventId);
                const teamRef = currentTeamId ? doc(db, 'teams', currentTeamId) : null;

                try {
                    if (isFavorited) { // Un-favoriting
                        await deleteDoc(favDocRef);
                        if (teamRef) {
                            const teamDoc = await getDoc(teamRef);
                            if (teamDoc.exists() && teamDoc.data().favorites && teamDoc.data().favorites[eventId]) {
                                if (teamDoc.data().favorites[eventId].length === 1) {
                                    await updateDoc(teamRef, { [`favorites.${eventId}`]: deleteField() });
                                } else {
                                    await updateDoc(teamRef, { [`favorites.${eventId}`]: arrayRemove(currentUserId) });
                                }
                            }
                        }
                    } else { // Favoriting
                        await setDoc(favDocRef, { addedAt: new Date() });
                        if (teamRef) {
                            await updateDoc(teamRef, { [`favorites.${eventId}`]: arrayUnion(currentUserId) });
                        }
                    }
                } catch (error) { console.error("Error updating favorite:", error); }
            }
            
            async function createTeam() {
                if (!currentUserId || !window.firebase) return;
                const { db, doc, writeBatch, collection } = window.firebase;
                const teamRef = doc(collection(db, 'teams'));
                const userRef = doc(db, 'users', currentUserId);
                const batch = writeBatch(db);
                batch.set(teamRef, { members: { [currentUserId]: userDisplayName.textContent }, favorites: {} }); 
                batch.update(userRef, { teamId: teamRef.id });
                await batch.commit();
                teamsModalInstance.hide();
            }

            async function joinTeam() {
                if (!currentUserId || !window.firebase) return;
                const { db, doc, getDoc, updateDoc } = window.firebase;
                const teamIdToJoin = getEl('join-team-id-input').value.trim();
                if (!teamIdToJoin) return;

                const teamRef = doc(db, 'teams', teamIdToJoin);
                const teamDoc = await getDoc(teamRef);
                const joinErrorEl = getEl('join-team-error');

                if (teamDoc.exists()) {
                    const userRef = doc(db, 'users', currentUserId);
                    const newMemberField = `members.${currentUserId}`;
                    await updateDoc(teamRef, { [newMemberField]: userDisplayName.textContent });
                    await updateDoc(userRef, { teamId: teamIdToJoin });
                    joinErrorEl.style.display = 'none';
                    teamsModalInstance.hide();
                } else {
                    joinErrorEl.textContent = "Team ID not found.";
                    joinErrorEl.style.display = 'block';
                }
            }
            
            async function leaveTeam() {
                 if (!currentUserId || !currentTeamId || !window.firebase) return;
                 const { db, doc, updateDoc, deleteField } = window.firebase;
                 const teamRef = doc(db, 'teams', currentTeamId);
                 const userRef = doc(db, 'users', currentUserId);
                 const memberField = `members.${currentUserId}`;
                 await updateDoc(teamRef, { [memberField]: deleteField() });
                 await updateDoc(userRef, { teamId: deleteField() });
                 teamsModalInstance.hide();
            }

            function setupAuthListener() {
                 if (!window.firebase) { setTimeout(setupAuthListener, 100); return; }
                const { auth, onAuthStateChanged, db, doc, onSnapshot, setDoc, collection } = window.firebase;
                onAuthStateChanged(auth, (user) => {
                    unsubscribeFavorites(); unsubscribeUser(); unsubscribeTeam();
                    teamFavorites.clear(); teamMembers.clear();
                    if (user) {
                        currentUserId = user.uid;
                        const userRef = doc(db, 'users', currentUserId);
                        const userName = user.displayName || user.email.split('@')[0];
                        setDoc(userRef, { name: userName, email: user.email }, { merge: true });

                        userDisplayName.textContent = userName;
                        getEl('user-status').textContent = user.email;
                        loginNavItem.style.display = 'none';
                        userNavItem.style.display = 'block';

                        unsubscribeUser = onSnapshot(userRef, (doc) => {
                            currentTeamId = doc.data()?.teamId || null;
                            listenToTeamChanges(); 
                        });

                        const favsRef = collection(db, "users", currentUserId, "favorites");
                        unsubscribeFavorites = onSnapshot(favsRef, (snapshot) => {
                            favoriteEvents.clear();
                            snapshot.forEach(doc => favoriteEvents.add(doc.id));
                            if (eventDataTable) eventDataTable.rows().invalidate('data').draw(false);
                        });

                        loadEvents(); 
                    } else {
                        currentUserId = null; currentTeamId = null;
                        favoriteEvents.clear(); allEvents = [];
                        loginNavItem.style.display = 'block'; userNavItem.style.display = 'none';
                        if (eventDataTable) { eventDataTable.clear().draw(); }
                        getEl('dataFreshness').textContent = "Please log in to view event data.";
                    }
                });
            }

            function listenToTeamChanges() {
                unsubscribeTeam();
                teamMembers.clear(); teamFavorites.clear();
                if (!currentTeamId || !window.firebase) { renderCalendarView(); updateTeamViewUI(); return; }
                
                const { db, doc, onSnapshot } = window.firebase;
                const teamRef = doc(db, 'teams', currentTeamId);
                
                unsubscribeTeam = onSnapshot(teamRef, (teamDoc) => {
                    if (teamDoc.exists()) {
                        const data = teamDoc.data();
                        teamMembers = new Map(Object.entries(data.members || {}));
                        
                        const newTeamFavorites = new Map();
                        teamMembers.forEach((name, memberId) => newTeamFavorites.set(memberId, new Set()));

                        const teamFavsData = data.favorites || {};
                        for (const eventId in teamFavsData) {
                            const favoritedBy = teamFavsData[eventId];
                            if(Array.isArray(favoritedBy)) {
                                favoritedBy.forEach(userId => {
                                    if(newTeamFavorites.has(userId)) {
                                        newTeamFavorites.get(userId).add(eventId);
                                    }
                                });
                            }
                        }
                        teamFavorites = newTeamFavorites;
                        
                        updateTeamViewUI();
                        if (document.getElementById('mainModal').classList.contains('show')) {
                           renderCalendarView();
                        }
                    } else {
                        currentTeamId = null;
                        updateTeamViewUI();
                    }
                });
            }

            async function loadEvents() {
                const { db, collection, getDocs } = window.firebase;
                const dataFreshnessElement = getEl('dataFreshness');
                const cacheKey = 'fm_events_cache';
                const cacheDuration = 60 * 60 * 1000; // 1 hour in milliseconds

                try {
                    const cachedData = JSON.parse(localStorage.getItem(cacheKey));

                    if (cachedData && (Date.now() - cachedData.timestamp < cacheDuration)) {
                        console.log("Loading events from cache.");
                        allEvents = cachedData.events;
                        dataFreshnessElement.textContent = `Live data loaded (cached).`;
                        initializeDataTable(allEvents);
                    } else {
                        console.log("Cache expired or empty. Fetching fresh events from Firestore.");
                        dataFreshnessElement.textContent = "Fetching data...";
                        const querySnapshot = await getDocs(collection(db, "events"));
                        allEvents = [];
                        querySnapshot.forEach((doc) => allEvents.push({ ...doc.data(), id: doc.id }));
                        
                        localStorage.setItem(cacheKey, JSON.stringify({
                            events: allEvents,
                            timestamp: Date.now()
                        }));

                        dataFreshnessElement.textContent = `Live data loaded.`;
                        initializeDataTable(allEvents);
                    }
                } catch (error) {
                    console.error("Error loading events:", error);
                    dataFreshnessElement.textContent = "Error loading data.";
                }
            }


            function initializeDataTable(data) {
                const colIdx = {}; ALL_DATA_HEADERS.forEach((h, i) => colIdx[h] = i);
            
                const processedData = data.map(e => {
                    const newEvent = { ...e };
                    if (!newEvent.EventTitle && newEvent.Description) {
                        const maxTitleLength = 70;
                        newEvent.EventTitle = newEvent.Description.length > maxTitleLength
                            ? newEvent.Description.substring(0, maxTitleLength - 3) + '...'
                            : newEvent.Description;
                    }
                    return ALL_DATA_HEADERS.map(h => newEvent[h] || '');
                });

                if (eventDataTable) { eventDataTable.destroy(); $('#eventTable tbody').empty(); }
                $('#eventTable thead').html(`<tr>${ALL_DATA_HEADERS.map(h => `<th>${h.replace(/([A-Z])/g, ' $1').trim()}</th>`).join('')}</tr>`);

                eventDataTable = $('#eventTable').DataTable({
                    data: processedData,
                    responsive: true,
                    lengthMenu: [[25, 50, 100, -1], [25, 50, 100, "All"]],
                    pageLength: 25,
                    order: [[colIdx.Weekday, 'asc'], [colIdx.TimeRange, 'asc']],
                    columnDefs: [
                        {
                            targets: colIdx.Favorite,
                            orderable: false,
                            className: 'text-center',
                            render: function(data, type, row) {
                                const eventId = row[colIdx.id];
                                const isFavorited = favoriteEvents.has(eventId);
                                return `<i class="${isFavorited ? 'fas' : 'far'} fa-heart favorite-icon" data-event-id="${eventId}"></i>`;
                            }
                        },
                        { targets: [colIdx.Description, colIdx.EventURL, colIdx.Organizers, colIdx.DataSource, colIdx.Theme, colIdx.id], visible: false }
                    ]
                });
                
                eventDataTable.on('draw.dt search.dt', updateVisualizations);
            }
            
            // --- UI RENDER & EVENT LISTENERS ---
            setupAuthListener();
            getEl('login-button').addEventListener('click', () => authModalInstance.show());
            getEl('authSignUpButton').addEventListener('click', () => {
                if (!window.firebase) return;
                window.firebase.createUserWithEmailAndPassword(window.firebase.auth, getEl('authEmail').value, getEl('authPassword').value)
                    .then(userCredential => authModalInstance.hide())
                    .catch(error => { getEl('authError').textContent = error.message; getEl('authError').style.display = "block"; });
            });
            getEl('authLoginButton').addEventListener('click', () => {
                if (!window.firebase) return;
                window.firebase.signInWithEmailAndPassword(window.firebase.auth, getEl('authEmail').value, getEl('authPassword').value)
                    .then(userCredential => authModalInstance.hide())
                    .catch(error => { getEl('authError').textContent = error.message; getEl('authError').style.display = "block"; });
            });
            getEl('googleLoginButton').addEventListener('click', () => {
                if (!window.firebase) return;
                const provider = new window.firebase.GoogleAuthProvider();
                window.firebase.signInWithPopup(window.firebase.auth, provider)
                    .then(result => authModalInstance.hide())
                    .catch(error => { getEl('authError').textContent = error.message; getEl('authError').style.display = "block"; });
            });
            getEl('logout-button').addEventListener('click', () => {
                if (window.firebase) window.firebase.signOut(window.firebase.auth);
            });

            teamButton.addEventListener('click', () => {
                if(currentUserId) {
                    teamsModalInstance.show();
                } else {
                    authModalInstance.show();
                }
            });

            calendarButton.addEventListener('click', () => {
                if(currentUserId) {
                    renderCalendarView();
                    mainModalTabs.calendar.show();
                    mainModalInstance.show();
                } else {
                    authModalInstance.show();
                }
            });

            getEl('create-team-button').addEventListener('click', createTeam);
            getEl('join-team-button').addEventListener('click', joinTeam);
            getEl('leave-team-button').addEventListener('click', leaveTeam);
            getEl('copy-team-id').addEventListener('click', () => navigator.clipboard.writeText(currentTeamId));

            let currentSourceFilter = "All", currentDayFilter = "All";
            function applyFilters() {
                if (!eventDataTable) return;
                const colIdx = {}; ALL_DATA_HEADERS.forEach((h, i) => colIdx[h] = i);
                const dsIdx = colIdx.DataSource, wdIdx = colIdx.Weekday;
                eventDataTable.column(dsIdx).search(currentSourceFilter === "All" ? '' : '^' + currentSourceFilter + '$', true, false);
                eventDataTable.column(wdIdx).search(currentDayFilter === "All" ? '' : '^' + currentDayFilter + '$', true, false).draw();
            }
            $('.source-filter-buttons .btn-check').on('change', function() { currentSourceFilter = $(this).data('source'); applyFilters(); });
            $('.filter-buttons .btn-check').on('change', function() { currentDayFilter = $(this).data('day'); applyFilters(); });

            $('#eventTable tbody').on('click', 'tr', function () {
                const rowData = eventDataTable.row(this).data();
                if (!rowData) return;
                renderDetailsView(rowData);
                mainModalTabs.details.show();
                mainModalInstance.show();
            });
            
            $('#eventTable tbody').on('click', '.favorite-icon', function (e) {
                e.stopPropagation();
                if(!currentUserId) { authModalInstance.show(); return; }
                const eventId = $(this).data('event-id');
                const isFavorited = favoriteEvents.has(eventId);
                toggleFavorite(eventId, isFavorited);
            });

            function renderDetailsView(rowData) {
                const colIdx = {}; ALL_DATA_HEADERS.forEach((h, i) => colIdx[h] = i);
                const eventData = {}; ALL_DATA_HEADERS.forEach(header => { eventData[header] = rowData[colIdx[header]]; });
                
                let modalHtml = `<h5 class="mb-3">${eventData.EventTitle}</h5><ul class="list-group list-group-flush">`;
                const modalDisplayOrder = [ { key: 'Description', label: 'Description' }, { key: 'Weekday', label: 'Day' }, { key: 'TimeRange', label: 'Time' }, { key: 'Location', label: 'Location' }, { key: 'Organizers', label: 'Organizers' }, { key: 'Theme', label: 'Theme' }, { key: 'EventURL', label: 'Link' }, { key: 'DataSource', label: 'Source' } ];
                
                modalDisplayOrder.forEach(item => {
                    const value = eventData[item.key];
                    if (value) {
                        if (item.key === 'EventURL' && value.startsWith('http')) {
                            modalHtml += `<li class="list-group-item"><p class="text-muted mb-1 small">${item.label}</p><a href="${value}" target="_blank" rel="noopener noreferrer">View Original Event</a></li>`;
                        } else {
                            modalHtml += `<li class="list-group-item"><p class="text-muted mb-1 small">${item.label}</p><p class="mb-0">${value}</p></li>`;
                        }
                    }
                });

                modalHtml += `</ul>`;
                detailsPane.innerHTML = modalHtml;
            }

            function renderCalendarView() {
                const personalFavs = allEvents.filter(e => favoriteEvents.has(e.id));
                const personalPane = getEl('personal-calendar-pane');
                if (personalFavs.length === 0) {
                    personalPane.innerHTML = `<p class="text-center text-muted mt-4">Your personal calendar is empty. Click the <i class="far fa-heart"></i> icon on an event to add it.</p>`;
                } else {
                    personalPane.innerHTML = buildCalendarTimeline(personalFavs);
                }

                const teamPane = getEl('team-calendar-pane');
                if (!currentTeamId) {
                    teamPane.innerHTML = `<p class="text-center text-muted mt-4">You are not in a team. Join or create one via the "My Team" button.</p>`;
                    return;
                }
                
                const allTeamFavs = new Map();
                teamFavorites.forEach((favs, userId) => {
                    const userName = teamMembers.get(userId) || 'Unknown';
                    favs.forEach(eventId => {
                        const event = allEvents.find(e => e.id === eventId);
                        if (event) {
                            if (!allTeamFavs.has(eventId)) {
                                allTeamFavs.set(eventId, { event, users: [] });
                            }
                            allTeamFavs.get(eventId).users.push({id: userId, name: userName});
                        }
                    });
                });

                if (allTeamFavs.size === 0) {
                    teamPane.innerHTML = `<p class="text-center text-muted mt-4">Your team calendar is empty.</p>`;
                    return;
                }
                
                teamPane.innerHTML = buildCalendarTimeline(Array.from(allTeamFavs.values()));
            }

            function buildCalendarTimeline(eventsData) {
                 const eventsByDay = eventsData.reduce((acc, data) => {
                    const event = data.event || data; // Handle both personal and team data structure
                    if (!acc[event.Weekday]) acc[event.Weekday] = [];
                    acc[event.Weekday].push(data);
                    return acc;
                }, {});

                let calendarHtml = '<div class="timeline-container">';
                ["Onsdag", "Torsdag", "Fredag", "Lørdag"].forEach(day => {
                    if (eventsByDay[day]) {
                        calendarHtml += `<div class="timeline-day"><h4>${day}</h4><div class="timeline-grid">`;
                        for (let hour = 8; hour <= 23; hour++) {
                            const top = (hour - 8) * 60;
                            calendarHtml += `<div class="time-label" style="top: ${top - 10}px;">${String(hour).padStart(2, '0')}:00</div>`;
                            calendarHtml += `<div class="time-line" style="top: ${top}px;"></div>`;
                        }

                        const placedEvents = [];
                        eventsByDay[day].sort((a,b) => ((a.event||a).TimeRange || "").localeCompare((b.event||b).TimeRange || "")).forEach((data) => {
                            const event = data.event || data;
                            const users = data.users || [{id: currentUserId, name: 'You'}];
                            
                            const timeParts = (event.TimeRange || "00:00-00:00").split('-');
                            const start = timeParts[0].split(':');
                            const end = timeParts.length > 1 ? timeParts[1].split(':') : start;
                            
                            const startMinutes = (parseInt(start[0], 10) * 60) + parseInt(start[1], 10);
                            const endMinutes = (parseInt(end[0], 10) * 60) + parseInt(end[1], 10);
                            const duration = Math.max(30, endMinutes - startMinutes);
                            
                            const top = (startMinutes - (8 * 60));
                            const height = duration;
                            
                            let eventClass = 'timeline-event';
                            if (!users.find(u => u.id === currentUserId)) {
                               eventClass += ' teammate';
                            }
                            const userHtml = users.map(u => u.name).join(', ');

                            let column = 0;
                            while(placedEvents.some(p => p.column === column && top < p.end && (top + height) > p.top)) {
                                column++;
                            }
                            placedEvents.push({top, end: top + height, column});
                            const left = 65 + (column * 155);

                            calendarHtml += `<div class="${eventClass}" style="top: ${top}px; height: ${height}px; width: 150px; left: ${left}px;" title="${event.EventTitle} - ${userHtml}"><strong>${event.EventTitle}</strong><br><small><i>${userHtml}</i></small></div>`;
                        });
                        calendarHtml += `</div></div>`;
                    }
                });
                calendarHtml += `</div>`;
                return calendarHtml;
            }

            function updateTeamViewUI() {
                const teamInfoView = getEl('team-info-view'), noTeamView = getEl('no-team-view');
                if (currentTeamId) {
                    teamInfoView.style.display = 'block'; noTeamView.style.display = 'none';
                    getEl('current-team-id').textContent = currentTeamId;
                    let membersHtml = '';
                    teamMembers.forEach((name, id) => {
                        membersHtml += `<li class="list-group-item">${name} ${id === currentUserId ? '(You)' : ''}</li>`;
                    });
                    getEl('team-members-list').innerHTML = membersHtml;
                } else {
                    teamInfoView.style.display = 'none'; noTeamView.style.display = 'block';
                }
            }

            function updateVisualizations() {
                if (!eventDataTable) return;
                const colIdx = {}; ALL_DATA_HEADERS.forEach((h, i) => colIdx[h] = i);
                const fData = eventDataTable.rows({ search: 'applied' }).data().toArray();
                
                getEl('stat-total-events').textContent = fData.length;
                let invOnlyCount = 0;
                const locCounts = {}, hrCnt = {};
                for (let i = 6; i < 24; i++) hrCnt[i.toString().padStart(2, '0')] = 0;

                fData.forEach(r => {
                    const tr = r[colIdx.TimeRange];
                    if (tr) { const sm = tr.match(/^(\d{2}):\d{2}/); if (sm && hrCnt.hasOwnProperty(sm[1])) hrCnt[sm[1]]++; }
                    const loc = r[colIdx.Location]; if (loc && loc.trim()) locCounts[loc] = (locCounts[loc] || 0) + 1;
                    if ((r[colIdx.EventTitle] || '').includes('!!Kun med invitation!!') || (r[colIdx.Description] || '').includes('!!Kun med invitation!!')) invOnlyCount++;
                });

                getEl('stat-invitation-only').textContent = invOnlyCount;
                const busiestHour = Object.entries(hrCnt).reduce((max, e) => e[1] > max[1] ? e : max, [null, -1]);
                getEl('stat-busiest-hour').textContent = busiestHour[1] > 0 ? `${busiestHour[0]}:00` : "--:--";
                const busiestLoc = Object.entries(locCounts).reduce((max, e) => e[1] > max[1] ? e : max, [null, -1]);
                const busiestLocEl = getEl('stat-busiest-location');
                busiestLocEl.textContent = busiestLoc[0] || "N/A";
                busiestLocEl.title = busiestLoc[0] || "N/A";

                const eventsPerHourChartInstance = Chart.getChart("eventsPerHourChart");
                if(eventsPerHourChartInstance) {
                    eventsPerHourChartInstance.data.labels = Object.keys(hrCnt).sort();
                    eventsPerHourChartInstance.data.datasets[0].data = Object.keys(hrCnt).sort().map(key => hrCnt[key]);
                    eventsPerHourChartInstance.update();
                }
            }
            
            getEl('toggleStatsButton').addEventListener('click', (e) => {
                const isExpanding = e.currentTarget.getAttribute('aria-expanded') !== 'true';
                getEl('toggleStatsButtonText').textContent = isExpanding ? 'Hide Statistics' : 'Show Statistics';
                 if(isExpanding) {
                     const hctx = getEl('eventsPerHourChart');
                     if(hctx) {
                        let chart = Chart.getChart(hctx);
                        if(!chart) {
                            chart = new Chart(hctx.getContext('2d'), {
                                type: 'bar',
                                data: { labels: [], datasets: [{ label: 'Events/Hour', data: [], backgroundColor: 'rgba(221, 0, 121, 0.7)', borderColor: 'rgba(221, 0, 121, 1)', borderWidth: 1 }] },
                                options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, responsive: true }
                            });
                        }
                        updateVisualizations();
                     }
                 }
            });
        });
    </script>
</body>
</html>
