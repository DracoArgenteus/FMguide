<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Folkemødet 2025 - Combined Event Schedule</title>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- MDB -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.2.0/mdb.min.css" rel="stylesheet" />
    <!-- DataTables -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    
    <script type="module">
        // Import the functions you need from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-analytics.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";
      
        // Your Firebase configuration object
        const firebaseConfig = {
            apiKey: "AIzaSyAwNsvDxANT6VKgWRl7bOu4FkTkmahKoss",
            authDomain: "fm-app-c58ab.firebaseapp.com",
            projectId: "fm-app-c58ab",
            storageBucket: "fm-app-c58ab.firebasestorage.app",
            messagingSenderId: "640978558377",
            appId: "1:640978558377:web:055e05ac645d49904d38b8",
            measurementId: "G-9GBEZCE9NG"
        };

        // Initialize Firebase
        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const analytics = getAnalytics(app);
            // Expose Firebase functions to the window object
            window.firebase = { 
                app, auth, db, 
                createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, 
                collection, getDocs, analytics,
                GoogleAuthProvider, signInWithPopup 
            };
            console.log("Firebase initialized successfully.");
        } catch (e) {
            console.error("Error initializing Firebase. Please check your firebaseConfig object.", e);
            alert("Could not initialize Firebase. Check your configuration and console for errors.");
        }
    </script>
    
    <!-- Custom Color Theme and Styles -->
    <style>
        :root {
            --mdb-primary: #dd0079;
            --mdb-primary-rgb: 221, 0, 121;
        }
        
        /* More specific overrides to ensure the theme is applied everywhere */
        .btn-primary,
        .btn-check:checked+.btn-primary {
            background-color: var(--mdb-primary) !important;
            border-color: var(--mdb-primary) !important;
        }

        .btn-outline-primary {
            color: var(--mdb-primary) !important;
            border-color: var(--mdb-primary) !important;
        }

        .btn-outline-primary:hover,
        .btn-check:checked+.btn-outline-primary {
            color: #fff !important;
            background-color: var(--mdb-primary) !important;
            border-color: var(--mdb-primary) !important;
        }

        a, .text-primary, .page-item.active .page-link {
            color: var(--mdb-primary) !important;
        }
        
        .page-item.active .page-link {
             background-color: var(--mdb-primary) !important;
             border-color: var(--mdb-primary) !important;
             color: #fff !important;
        }
        
        .dataTables_info {
             color: var(--mdb-primary) !important;
        }

        /* Custom styles for better integration */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
            padding-top: 58px; /* Offset for fixed navbar */
        }
        .invitation-only {
            background-color: rgba(221, 0, 121, 0.1) !important;
        }
        html[data-mdb-theme="dark"] .invitation-only {
            background-color: rgba(221, 0, 121, 0.2) !important;
        }
        .dataTables_wrapper .form-outline {
            border: 1px solid #dee2e6;
            border-radius: .25rem;
        }
        html[data-mdb-theme="dark"] .dataTables_wrapper .form-outline {
            border-color: #4f4f4f;
        }
        #eventTable tbody tr {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Auth Modal -->
    <div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="authModalLabel">Login / Sign Up</h5>
                    <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div data-mdb-input-init class="form-outline mb-4">
                        <input type="email" id="authEmail" class="form-control" />
                        <label class="form-label" for="authEmail">Email address</label>
                    </div>
                    <div data-mdb-input-init class="form-outline mb-4">
                        <input type="password" id="authPassword" class="form-control" />
                        <label class="form-label" for="authPassword">Password (min. 6 characters)</label>
                    </div>
                    <p id="authError" class="text-danger small mb-3" style="display: none;"></p>
                    <div class="d-flex justify-content-end mb-3">
                        <button id="authSignUpButton" type="button" data-mdb-button-init data-mdb-ripple-init class="btn btn-light me-2">Sign Up</button>
                        <button id="authLoginButton" type="button" data-mdb-button-init data-mdb-ripple-init class="btn btn-primary">Login</button>
                    </div>
                    <hr/>
                    <div class="text-center">
                        <button id="googleLoginButton" type="button" data-mdb-button-init data-mdb-ripple-init class="btn btn-primary btn-block">
                            <i class="fab fa-google me-2"></i>Continue with Google
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand text-primary" href="#"><strong>Folkemødet 2025</strong></a>
            <button class="navbar-toggler" type="button" data-mdb-collapse-init data-mdb-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <i class="fas fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center">
                    <li class="nav-item">
                        <button id="toggleStatsButton" class="btn btn-outline-primary btn-sm m-1" type="button" data-mdb-collapse-init data-mdb-ripple-init href="#statsSectionContainer" aria-expanded="false" aria-controls="statsSectionContainer">
                            <i class="fas fa-chart-bar me-lg-2"></i><span id="toggleStatsButtonText" class="d-lg-none d-xl-inline">Show Statistics</span>
                        </button>
                    </li>
                    <li class="nav-item">
                        <button id="theme-toggle" class="btn btn-outline-primary btn-sm m-1"><i class="fas fa-sun"></i><i class="fas fa-moon" style="display: none;"></i></button>
                    </li>
                    <li id="login-nav-item" class="nav-item">
                        <button id="login-button" type="button" data-mdb-button-init data-mdb-ripple-init class="btn btn-primary btn-sm m-1">Login</button>
                    </li>
                    <li id="user-nav-item" class="nav-item dropdown" style="display: none;">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarDropdown" role="button" data-mdb-dropdown-init aria-expanded="false">
                           <i class="fas fa-user-circle fa-lg me-2"></i> <span id="user-display-name"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><h6 class="dropdown-header" id="user-status">Signed in as</h6></li>
                            <li><hr class="dropdown-divider" /></li>
                            <li><a class="dropdown-item" href="#" id="logout-button"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content Container -->
    <div class="container mt-4 mb-5">
        <header class="mb-4 text-center">
            <h1 class="text-primary">Combined Event Schedule</h1>
            <p id="dataFreshness" class="text-muted small">Loading data...</p>
        </header>

        <!-- Stats Section -->
        <div class="collapse" id="statsSectionContainer">
            <div class="card mb-4">
                <div class="card-body">
                     <h3 class="text-primary mb-4 text-center">Filtered Statistics</h3>
                     <div class="row text-center">
                         <div class="col-md-3 col-6 mb-4"><h5 class="text-muted">Total Events</h5><p id="stat-total-events" class="h2 mb-0">0</p></div>
                         <div class="col-md-3 col-6 mb-4"><h5 class="text-muted">Busiest Hour</h5><p id="stat-busiest-hour" class="h2 mb-0">--:--</p></div>
                         <div class="col-md-3 col-6 mb-4"><h5 class="text-muted">Busiest Location</h5><p id="stat-busiest-location" class="h5 mb-0 text-truncate" title="N/A">N/A</p></div>
                         <div class="col-md-3 col-6 mb-4"><h5 class="text-muted">Invitation Only</h5><p id="stat-invitation-only" class="h2 mb-0">0</p></div>
                     </div>
                     <hr/>
                     <div class="chart-wrapper mt-4"><h4 class="text-center text-muted mb-3">Events per Hour</h4><canvas id="eventsPerHourChart"></canvas></div>
                </div>
            </div>
        </div>

        <div id="tableErrorMessage" class="alert alert-danger" style="display: none;"></div>

        <div class="card">
             <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6 mb-3 mb-md-0">
                        <h5 class="mb-2">Filter by Source:</h5>
                        <div class="btn-group source-filter-buttons" role="group">
                            <input type="radio" class="btn-check" name="sourceFilter" id="sourceAll" autocomplete="off" data-source="All" checked />
                            <label class="btn btn-outline-primary" for="sourceAll">All</label>

                            <input type="radio" class="btn-check" name="sourceFilter" id="sourceOfficial" autocomplete="off" data-source="Official" />
                            <label class="btn btn-outline-primary" for="sourceOfficial">Official</label>

                            <input type="radio" class="btn-check" name="sourceFilter" id="sourcePrivate" autocomplete="off" data-source="Private" />
                            <label class="btn btn-outline-primary" for="sourcePrivate">Private</label>

                            <input type="radio" class="btn-check" name="sourceFilter" id="sourceSocial" autocomplete="off" data-source="Social" />
                            <label class="btn btn-outline-primary" for="sourceSocial">Social</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5 class="mb-2">Filter by Day:</h5>
                        <div class="btn-group filter-buttons" role="group">
                           <input type="radio" class="btn-check" name="dayFilter" id="dayAll" autocomplete="off" data-day="All" checked />
                           <label class="btn btn-outline-primary" for="dayAll">All</label>

                           <input type="radio" class="btn-check" name="dayFilter" id="dayOnsdag" autocomplete="off" data-day="Onsdag" />
                           <label class="btn btn-outline-primary" for="dayOnsdag">Onsdag</label>

                           <input type="radio" class="btn-check" name="dayFilter" id="dayTorsdag" autocomplete="off" data-day="Torsdag" />
                           <label class="btn btn-outline-primary" for="dayTorsdag">Torsdag</label>

                           <input type="radio" class="btn-check" name="dayFilter" id="dayFredag" autocomplete="off" data-day="Fredag" />
                           <label class="btn btn-outline-primary" for="dayFredag">Fredag</label>

                           <input type="radio" class="btn-check" name="dayFilter" id="dayLørdag" autocomplete="off" data-day="Lørdag" />
                           <label class="btn btn-outline-primary" for="dayLørdag">Lørdag</label>
                        </div>
                    </div>
                </div>
                <div class="table-responsive"><table id="eventTable" class="table table-striped table-hover"><thead></thead><tbody></tbody></table></div>
             </div>
        </div>

        <footer class="mt-5 text-center text-muted small"><p>&copy; <span id="currentYear"></span> Folkemødet Event Viewer.</p></footer>
    </div>
    
    <!-- Description Modal -->
    <div class="modal fade" id="descriptionModal" tabindex="-1" aria-labelledby="descriptionModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Event Details</h5>
            <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="modalBodyContent">
            <!-- Content will be dynamically injected here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <!-- MDB -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.2.0/mdb.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <script>
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        const ALL_DATA_HEADERS = ["EventTitle", "Weekday", "TimeRange", "Location", "Description", "EventURL", "Organizers", "Theme", "DataSource"];


        $(document).ready(function() {
            let eventDataTable = null;
            let allEvents = [];
            let authModalInstance, descriptionModalInstance;

            // --- ALL DOM ELEMENT GETTERS ---
            const getEl = (id) => document.getElementById(id);
            const tableErrorMessageDiv = getEl('tableErrorMessage');
            const dataFreshnessElement = getEl('dataFreshness');
            const toggleStatsButton = getEl('toggleStatsButton');
            const modalTitle = getEl('modalTitle');
            const modalBodyContent = getEl('modalBodyContent');
            const authEmailInput = getEl('authEmail');
            const authPasswordInput = getEl('authPassword');
            const authError = getEl('authError');
            const loginButton = getEl('login-button');
            const logoutButton = getEl('logout-button');
            const userStatus = getEl('user-status');
            const themeToggleButton = getEl('theme-toggle');
            const loginNavItem = getEl('login-nav-item');
            const userNavItem = getEl('user-nav-item');
            const userDisplayName = getEl('user-display-name');

            let eventsPerHourChartInstance = null;

            // --- MODAL INITIALIZATION ---
            authModalInstance = new mdb.Modal(getEl('authModal'));
            descriptionModalInstance = new mdb.Modal(getEl('descriptionModal'));

            // --- THEME SWITCHER LOGIC ---
            const sunIcon = themeToggleButton.querySelector('.fa-sun');
            const moonIcon = themeToggleButton.querySelector('.fa-moon');
            
            function applyTheme(isDark) {
                document.documentElement.setAttribute('data-mdb-theme', isDark ? 'dark' : 'light');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                sunIcon.style.display = isDark ? 'none' : 'inline-block';
                moonIcon.style.display = isDark ? 'inline-block' : 'none';
                const chartTextColor = isDark ? '#adb5bd' : '#4f4f4f';
                const chartGridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                Chart.defaults.color = chartTextColor;
                Chart.defaults.borderColor = chartGridColor;
                if(eventsPerHourChartInstance) eventsPerHourChartInstance.update();
                if(eventDataTable) eventDataTable.draw(false);
            }

            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(localStorage.theme === 'dark' || (!localStorage.theme && prefersDark));
            themeToggleButton.addEventListener('click', () => applyTheme(localStorage.theme !== 'dark'));

            // --- FIREBASE AUTH LOGIC ---
            loginButton.addEventListener('click', () => authModalInstance.show());
            getEl('authSignUpButton').addEventListener('click', () => {
                if (!window.firebase) { alert("Firebase is not initialized."); return; }
                window.firebase.createUserWithEmailAndPassword(window.firebase.auth, authEmailInput.value, authPasswordInput.value)
                    .then(userCredential => authModalInstance.hide())
                    .catch(error => { authError.textContent = error.message; authError.style.display = "block"; });
            });
            getEl('authLoginButton').addEventListener('click', () => {
                if (!window.firebase) { alert("Firebase is not initialized."); return; }
                window.firebase.signInWithEmailAndPassword(window.firebase.auth, authEmailInput.value, authPasswordInput.value)
                    .then(userCredential => authModalInstance.hide())
                    .catch(error => { authError.textContent = error.message; authError.style.display = "block"; });
            });
            
            getEl('googleLoginButton').addEventListener('click', () => {
                if (!window.firebase) { alert("Firebase is not initialized."); return; }
                const provider = new window.firebase.GoogleAuthProvider();
                window.firebase.signInWithPopup(window.firebase.auth, provider)
                    .then(result => authModalInstance.hide())
                    .catch(error => { authError.textContent = error.message; authError.style.display = "block"; });
            });
            logoutButton.addEventListener('click', () => {
                if (window.firebase) window.firebase.signOut(window.firebase.auth).catch(error => console.error("Logout error:", error));
            });
            
            // --- DATA FETCH & TABLE LOGIC ---
            async function fetchEventsFromFirestore() {
                if (!window.firebase) {
                    tableErrorMessageDiv.textContent = "Firebase is not ready. Cannot fetch data.";
                    tableErrorMessageDiv.style.display = 'block';
                    return;
                }
                dataFreshnessElement.textContent = "Fetching data from database...";
                const { db, collection, getDocs } = window.firebase;
                try {
                    const querySnapshot = await getDocs(collection(db, "events"));
                    const firestoreEvents = [];
                    querySnapshot.forEach((doc) => firestoreEvents.push({ id: doc.id, ...doc.data() }));
                    console.log(`Successfully fetched ${firestoreEvents.length} events.`);
                    dataFreshnessElement.textContent = `Live data loaded successfully.`;
                    allEvents = firestoreEvents;
                    initializeDataTable(allEvents);
                } catch (error) {
                    console.error("Error fetching events from Firestore:", error);
                    tableErrorMessageDiv.textContent = `Error fetching data: ${error.message}`;
                    tableErrorMessageDiv.style.display = 'block';
                }
            }

            function initializeDataTable(data) {
                tableErrorMessageDiv.style.display = 'none';
                
                const processedData = data.map(e => {
                    const newEvent = { ...e }; 
                    if (!newEvent.EventTitle && newEvent.Description) {
                        const maxTitleLength = 70;
                        newEvent.EventTitle = newEvent.Description.length > maxTitleLength
                            ? newEvent.Description.substring(0, maxTitleLength - 3) + '...'
                            : newEvent.Description;
                    }
                    return ALL_DATA_HEADERS.map(h => newEvent[h] || '');
                });

                let headerHtml = '<tr>';
                ALL_DATA_HEADERS.forEach(h => { headerHtml += `<th>${h.replace(/([A-Z])/g, ' $1').trim()}</th>`; });
                headerHtml += '</tr>';
                $('#eventTable thead').html(headerHtml);
                
                const colIdx = {}; ALL_DATA_HEADERS.forEach((h, i) => colIdx[h] = i);

                if (eventDataTable) { eventDataTable.destroy(); $('#eventTable tbody').empty(); }

                eventDataTable = $('#eventTable').DataTable({
                    data: processedData, 
                    responsive: true,
                    lengthMenu: [[25, 50, 100, -1], [25, 50, 100, "All"]],
                    pageLength: 25,
                    order: [[colIdx.Weekday, 'asc'], [colIdx.TimeRange, 'asc']],
                    createdRow: function (row, data) {
                        if ((data[colIdx.EventTitle] || '').includes('!!Kun med invitation!!') || (data[colIdx.Description] || '').includes('!!Kun med invitation!!')) {
                            $(row).addClass('invitation-only');
                        }
                    },
                    // ***UPDATED***: Hide Theme column as well
                    columnDefs: [
                        { targets: [colIdx.Description, colIdx.EventURL, colIdx.Organizers, colIdx.DataSource, colIdx.Theme], visible: false },
                        { targets: '_all', visible: true }
                    ]
                });

                initializeCharts();
                eventDataTable.on('draw.dt search.dt', updateVisualizations);
                updateVisualizations();
            }

            // --- AUTH STATE LISTENER (MAIN TRIGGER) ---
            function setupAuthListener() {
                if (!window.firebase) { setTimeout(setupAuthListener, 100); return; }
                window.firebase.onAuthStateChanged(window.firebase.auth, (user) => {
                    if (user) {
                        const name = user.displayName || user.email;
                        userStatus.textContent = name;
                        userDisplayName.textContent = name;
                        loginNavItem.style.display = 'none';
                        userNavItem.style.display = 'block';
                        fetchEventsFromFirestore();
                    } else {
                        loginNavItem.style.display = 'block';
                        userNavItem.style.display = 'none';
                        if (eventDataTable) { eventDataTable.clear().draw(); }
                        dataFreshnessElement.textContent = "Please log in to view event data.";
                    }
                });
            }
            setupAuthListener();

            // --- FILTERS, MODALS, CHARTS ---
            let currentSourceFilter = "All", currentDayFilter = "All";
            function applyFilters() {
                if (!eventDataTable) return;
                const dsIdx = ALL_DATA_HEADERS.indexOf("DataSource"), wdIdx = ALL_DATA_HEADERS.indexOf("Weekday");
                eventDataTable.column(dsIdx).search(currentSourceFilter === "All" ? '' : '^' + currentSourceFilter + '$', true, false).draw(false);
                eventDataTable.column(wdIdx).search(currentDayFilter === "All" ? '' : '^' + currentDayFilter + '$', true, false).draw();
            }
            $('.source-filter-buttons .btn-check').on('change', function() { currentSourceFilter = $(this).data('source'); applyFilters(); });
            $('.filter-buttons .btn-check').on('change', function() { currentDayFilter = $(this).data('day'); applyFilters(); });
            
            $('#eventTable tbody').on('click', 'tr', function () {
                const rowData = eventDataTable.row(this).data();
                if (!rowData) return;

                const colIdx = {}; ALL_DATA_HEADERS.forEach((h, i) => colIdx[h] = i);
                
                const eventData = {};
                ALL_DATA_HEADERS.forEach(header => {
                    eventData[header] = rowData[colIdx[header]];
                });

                modalTitle.textContent = eventData.EventTitle || "Event Details";
                
                // ***UPDATED***: Dynamically build the modal body to show all event data
                let modalHtml = `<ul class="list-group list-group-flush">`;
                
                // Define the order and labels for the modal
                const modalDisplayOrder = [
                    { key: 'Description', label: 'Description' },
                    { key: 'Weekday', label: 'Day' },
                    { key: 'TimeRange', label: 'Time' },
                    { key: 'Location', label: 'Location' },
                    { key: 'Organizers', label: 'Organizers' },
                    { key: 'Theme', label: 'Theme' },
                    { key: 'EventURL', label: 'Link' },
                    { key: 'DataSource', label: 'Source' }
                ];
                
                modalDisplayOrder.forEach(item => {
                    const value = eventData[item.key];
                    if (value) { // Only show item if it has a value
                        if (item.key === 'EventURL' && value.startsWith('http')) {
                            modalHtml += `<li class="list-group-item"><p class="text-muted mb-1 small">${item.label}</p><a href="${value}" target="_blank" rel="noopener noreferrer">View Original Event</a></li>`;
                        } else {
                            modalHtml += `<li class="list-group-item"><p class="text-muted mb-1 small">${item.label}</p><p class="mb-0">${value}</p></li>`;
                        }
                    }
                });

                modalHtml += `</ul>`;

                modalBodyContent.innerHTML = modalHtml;
                descriptionModalInstance.show();
            });

            function initializeCharts() {
                const hctx = getEl('eventsPerHourChart');
                if (!hctx) return;
                if (eventsPerHourChartInstance) eventsPerHourChartInstance.destroy();
                const primaryColor = 'rgba(221, 0, 121, 0.7)';
                const primaryBorderColor = 'rgba(221, 0, 121, 1)';
                
                eventsPerHourChartInstance = new Chart(hctx.getContext('2d'), {
                    type: 'bar',
                    data: { labels: [], datasets: [{ label: 'Events/Hour', data: [], backgroundColor: primaryColor, borderColor: primaryBorderColor, borderWidth: 1 }] },
                    options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, responsive: true }
                });
                applyTheme(localStorage.theme === 'dark'); 
            }

            function updateVisualizations() {
                if (!eventDataTable) return;
                const colIdx = {}; ALL_DATA_HEADERS.forEach((h, i) => colIdx[h] = i);
                const fData = eventDataTable.rows({ search: 'applied' }).data().toArray();
                
                getEl('stat-total-events').textContent = fData.length;
                let invOnlyCount = 0;
                const locCounts = {}, hrCnt = {};
                for (let i = 6; i < 24; i++) hrCnt[i.toString().padStart(2, '0')] = 0;

                fData.forEach(r => {
                    const tr = r[colIdx.TimeRange];
                    if (tr) { const sm = tr.match(/^(\d{2}):\d{2}/); if (sm && hrCnt.hasOwnProperty(sm[1])) hrCnt[sm[1]]++; }
                    const loc = r[colIdx.Location]; if (loc && loc.trim()) locCounts[loc] = (locCounts[loc] || 0) + 1;
                    if ((r[colIdx.EventTitle] || '').includes('!!Kun med invitation!!') || (r[colIdx.Description] || '').includes('!!Kun med invitation!!')) invOnlyCount++;
                });

                getEl('stat-invitation-only').textContent = invOnlyCount;
                const busiestHour = Object.entries(hrCnt).reduce((max, e) => e[1] > max[1] ? e : max, [null, -1]);
                getEl('stat-busiest-hour').textContent = busiestHour[1] > 0 ? `${busiestHour[0]}:00` : "--:--";
                const busiestLoc = Object.entries(locCounts).reduce((max, e) => e[1] > max[1] ? e : max, [null, -1]);
                const busiestLocEl = getEl('stat-busiest-location');
                busiestLocEl.textContent = busiestLoc[0] || "N/A";
                busiestLocEl.title = busiestLoc[0] || "N/A";

                eventsPerHourChartInstance.data.labels = Object.keys(hrCnt).sort();
                eventsPerHourChartInstance.data.datasets[0].data = Object.keys(hrCnt).sort().map(key => hrCnt[key]);
                eventsPerHourChartInstance.update();
            }

            toggleStatsButton.addEventListener('click', (e) => {
                const isExpanding = e.currentTarget.getAttribute('aria-expanded') !== 'true';
                getEl('toggleStatsButtonText').textContent = isExpanding ? 'Hide Statistics' : 'Show Statistics';
                 if(isExpanding) setTimeout(() => eventsPerHourChartInstance && eventsPerHourChartInstance.resize(), 350);
            });
        });
    </script>
</body>
</html>
