<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Folkem√∏det 2025 - Combined Event Schedule</title>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- MDB -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.2.0/mdb.min.css" rel="stylesheet" />
    <!-- DataTables -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    
    <script type="module">
        // Import the functions you need from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-analytics.js";
        // ***UPDATED***: Added getFunctions and httpsCallable
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-functions.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, onSnapshot, setDoc, deleteDoc, writeBatch, getDoc, updateDoc, deleteField, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";
      
        // Your Firebase configuration object
        const firebaseConfig = {
            apiKey: "AIzaSyAwNsvDxANT6VKgWRl7bOu4FkTkmahKoss",
            authDomain: "fm-app-c58ab.firebaseapp.com",
            projectId: "fm-app-c58ab",
            storageBucket: "fm-app-c58ab.firebasestorage.app",
            messagingSenderId: "640978558377",
            appId: "1:640978558377:web:055e05ac645d49904d38b8",
            measurementId: "G-9GBEZCE9NG"
        };

        // Initialize Firebase
        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const analytics = getAnalytics(app);
            const functions = getFunctions(app); // Initialize Cloud Functions
            window.firebase = { 
                app, auth, db, functions, // Add functions to window object
                createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, 
                collection, getDocs, analytics,
                GoogleAuthProvider, signInWithPopup, sendPasswordResetEmail,
                httpsCallable, // Expose httpsCallable
                doc, onSnapshot, setDoc, deleteDoc, writeBatch, getDoc, updateDoc, deleteField,
                arrayUnion, arrayRemove
            };
            console.log("Firebase initialized successfully.");
        } catch (e) {
            console.error("Error initializing Firebase:", e);
        }
    </script>
    
    <!-- Custom Color Theme and Styles -->
    <style>
        :root {
            --mdb-primary: #dd0079;
            --mdb-primary-rgb: 221, 0, 121;
        }
        .btn-primary, .btn-check:checked+.btn-primary { background-color: var(--mdb-primary) !important; border-color: var(--mdb-primary) !important; }
        .btn-outline-primary { color: var(--mdb-primary) !important; border-color: var(--mdb-primary) !important; }
        .btn-outline-primary:hover, .btn-check:checked+.btn-outline-primary { color: #fff !important; background-color: var(--mdb-primary) !important; border-color: var(--mdb-primary) !important; }
        a, .text-primary, .page-item.active .page-link { color: var(--mdb-primary) !important; }
        .page-item.active .page-link { background-color: var(--mdb-primary) !important; border-color: var(--mdb-primary) !important; color: #fff !important; }
        .dataTables_info { color: var(--mdb-primary) !important; }
        body { font-family: 'Inter', sans-serif; padding-top: 58px; }
        .invitation-only { background-color: rgba(221, 0, 121, 0.1) !important; }
        html[data-mdb-theme="dark"] .invitation-only { background-color: rgba(221, 0, 121, 0.2) !important; }
        #eventTable tbody tr { cursor: pointer; }
        .favorite-icon { color: var(--mdb-primary); transition: transform 0.2s ease-in-out; }
        .favorite-icon:hover { transform: scale(1.2); }
        .timeline-container { overflow-x: auto; }
        .timeline-day { margin-bottom: 2rem; }
        .timeline-grid { position: relative; min-height: 960px; /* 16 hours * 60px */ }
        .time-label { position: absolute; left: 0; width: 50px; text-align: right; padding-right: 10px; font-size: 0.8em; color: #9e9e9e; }
        .time-line { position: absolute; left: 60px; right: 0; height: 1px; background-color: #eee; }
        html[data-mdb-theme="dark"] .time-line { background-color: #4f4f4f; }
        .timeline-event { position: absolute; left: 65px; background-color: rgba(var(--mdb-primary-rgb), 0.8); color: white; border-left: 3px solid var(--mdb-primary); padding: 5px 8px; border-radius: 4px; font-size: 0.8em; overflow: hidden; z-index: 1; }
        .timeline-event.teammate { background-color: rgba(108, 117, 125, 0.8); border-left-color: #6c757d; }
    </style>
</head>
<body>
    <!-- Auth Modal -->
    <div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="authModalLabel">Login / Sign Up</h5><button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button></div>
                <div class="modal-body">
                    <div data-mdb-input-init class="form-outline mb-4"><input type="email" id="authEmail" class="form-control" /><label class="form-label" for="authEmail">Email address</label></div>
                    <div data-mdb-input-init class="form-outline mb-4"><input type="password" id="authPassword" class="form-control" /><label class="form-label" for="authPassword">Password (min. 6 characters)</label></div>
                    <div id="signup-key-wrapper" class="form-outline mb-4" data-mdb-input-init><input type="text" id="inviteCode" class="form-control" /><label class="form-label" for="inviteCode">Invite Code</label></div>
                    <p id="authError" class="text-danger small mb-3" style="display: none;"></p>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <a href="#" id="forgot-password-link">Forgot Password?</a>
                        <div>
                            <button id="authSignUpButton" type="button" data-mdb-button-init data-mdb-ripple-init class="btn btn-light me-2">Sign Up</button>
                            <button id="authLoginButton" type="button" data-mdb-button-init data-mdb-ripple-init class="btn btn-primary">Login</button>
                        </div>
                    </div>
                    <hr/>
                    <div class="text-center"><button id="googleLoginButton" type="button" data-mdb-button-init data-mdb-ripple-init class="btn btn-primary btn-block"><i class="fab fa-google me-2"></i>Continue with Google</button></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Password Reset Modal -->
    <div class="modal fade" id="passwordResetModal" tabindex="-1" aria-labelledby="passwordResetModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="passwordResetModalLabel">Reset Password</h5><button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button></div>
                <div class="modal-body">
                    <p>Enter your email address and we will send you a link to reset your password.</p>
                    <div data-mdb-input-init class="form-outline mb-4"><input type="email" id="resetEmail" class="form-control" /><label class="form-label" for="resetEmail">Email address</label></div>
                    <p id="resetError" class="text-danger small" style="display: none;"></p>
                    <p id="resetSuccess" class="text-success small" style="display: none;"></p>
                    <button id="resetPasswordButton" class="btn btn-primary btn-block">Send Reset Link</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Teams Modal -->
    <div class="modal fade" id="teamsModal" tabindex="-1" aria-labelledby="teamsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="teamsModalLabel">My Team</h5><button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button></div>
                <div class="modal-body">
                    <div id="team-info-view">
                        <p>Your Team ID: <strong id="current-team-id" class="text-primary"></strong> <button id="copy-team-id" class="btn btn-sm btn-light py-1 px-2 ms-2"><i class="far fa-copy"></i></button></p>
                        <h6>Team Members:</h6>
                        <ul id="team-members-list" class="list-group list-group-light mb-3"></ul>
                        <button id="leave-team-button" class="btn btn-danger btn-block">Leave Team</button>
                    </div>
                    <div id="no-team-view">
                        <p>You are not currently in a team.</p>
                        <hr/>
                        <h6>Join a Team</h6>
                        <div class="input-group mb-3">
                            <input type="text" id="join-team-id-input" class="form-control" placeholder="Enter Team ID"/>
                            <button id="join-team-button" class="btn btn-primary">Join</button>
                        </div>
                        <p id="join-team-error" class="text-danger small" style="display:none;"></p>
                        <h6>Create a Team</h6>
                        <button id="create-team-button" class="btn btn-outline-primary btn-block">Create New Team</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand text-primary" href="#"><strong>Folkem√∏det 2025</strong></a>
            <button class="navbar-toggler" type="button" data-mdb-collapse-init data-mdb-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation"><i class="fas fa-bars"></i></button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center">
                    <li class="nav-item"><button id="team-button" class="btn btn-outline-primary btn-sm m-1"><i class="fas fa-users me-lg-2"></i><span class="d-lg-none d-xl-inline">My Team</span></button></li>
                    <li class="nav-item"><button id="calendar-button" class="btn btn-outline-primary btn-sm m-1"><i class="far fa-calendar-alt me-lg-2"></i><span class="d-lg-none d-xl-inline">My Calendar</span></button></li>
                    <li class="nav-item"><button id="toggleStatsButton" class="btn btn-outline-primary btn-sm m-1" type="button" data-mdb-collapse-init data-mdb-ripple-init href="#statsSectionContainer"><i class="fas fa-chart-bar me-lg-2"></i><span id="toggleStatsButtonText" class="d-lg-none d-xl-inline">Show Statistics</span></button></li>
                    <li class="nav-item"><button id="theme-toggle" class="btn btn-outline-primary btn-sm m-1"><i class="fas fa-sun"></i><i class="fas fa-moon" style="display: none;"></i></button></li>
                    <li id="login-nav-item" class="nav-item"><button id="login-button" type="button" data-mdb-button-init data-mdb-ripple-init class="btn btn-primary btn-sm m-1">Login</button></li>
                    <li id="user-nav-item" class="nav-item dropdown" style="display: none;">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarDropdown" role="button" data-mdb-dropdown-init aria-expanded="false"><i class="fas fa-user-circle fa-lg me-2"></i> <span id="user-display-name"></span></a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><h6 class="dropdown-header" id="user-status">Signed in as</h6></li>
                            <li><hr class="dropdown-divider" /></li>
                            <li><a class="dropdown-item" href="#" id="reset-password-menu-item"><i class="fas fa-key me-2"></i>Reset Password</a></li>
                            <li><a class="dropdown-item" href="#" id="logout-button"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content Container -->
    <div class="container mt-4 mb-5">
        <header class="mb-4 text-center"><h1 class="text-primary">Combined Event Schedule</h1><p id="dataFreshness" class="text-muted small">Loading data...</p></header>
        <div class="collapse" id="statsSectionContainer">
            <div class="card mb-4"><div class="card-body"><h3 class="text-primary mb-4 text-center">Filtered Statistics</h3><div class="row text-center"><div class="col-md-3 col-6 mb-4"><h5 class="text-muted">Total Events</h5><p id="stat-total-events" class="h2 mb-0">0</p></div><div class="col-md-3 col-6 mb-4"><h5 class="text-muted">Busiest Hour</h5><p id="stat-busiest-hour" class="h2 mb-0">--:--</p></div><div class="col-md-3 col-6 mb-4"><h5 class="text-muted">Busiest Location</h5><p id="stat-busiest-location" class="h5 mb-0 text-truncate" title="N/A">N/A</p></div><div class="col-md-3 col-6 mb-4"><h5 class="text-muted">Invitation Only</h5><p id="stat-invitation-only" class="h2 mb-0">0</p></div></div><hr/><div class="chart-wrapper mt-4"><h4 class="text-center text-muted mb-3">Events per Hour</h4><canvas id="eventsPerHourChart"></canvas></div></div></div>
        </div>
        <div id="tableErrorMessage" class="alert alert-danger" style="display: none;"></div>
        <div class="card"><div class="card-body"><div class="row mb-4"><div class="col-md-6 mb-3 mb-md-0"><h5 class="mb-2">Filter by Source:</h5><div class="btn-group source-filter-buttons" role="group"><input type="radio" class="btn-check" name="sourceFilter" id="sourceAll" autocomplete="off" data-source="All" checked /><label class="btn btn-outline-primary" for="sourceAll">All</label><input type="radio" class="btn-check" name="sourceFilter" id="sourceOfficial" autocomplete="off" data-source="Official" /><label class="btn btn-outline-primary" for="sourceOfficial">Official</label><input type="radio" class="btn-check" name="sourceFilter" id="sourcePrivate" autocomplete="off" data-source="Private" /><label class="btn btn-outline-primary" for="sourcePrivate">Private</label><input type="radio" class="btn-check" name="sourceFilter" id="sourceSocial" autocomplete="off" data-source="Social" /><label class="btn btn-outline-primary" for="sourceSocial">Social</label></div></div><div class="col-md-6"><h5 class="mb-2">Filter by Day:</h5><div class="btn-group filter-buttons" role="group"><input type="radio" class="btn-check" name="dayFilter" id="dayAll" autocomplete="off" data-day="All" checked /><label class="btn btn-outline-primary" for="dayAll">All</label><input type="radio" class="btn-check" name="dayFilter" id="dayOnsdag" autocomplete="off" data-day="Onsdag" /><label class="btn btn-outline-primary" for="dayOnsdag">Onsdag</label><input type="radio" class="btn-check" name="dayFilter" id="dayTorsdag" autocomplete="off" data-day="Torsdag" /><label class="btn btn-outline-primary" for="dayTorsdag">Torsdag</label><input type="radio" class="btn-check" name="dayFilter" id="dayFredag" autocomplete="off" data-day="Fredag" /><label class="btn btn-outline-primary" for="dayFredag">Fredag</label><input type="radio" class="btn-check" name="dayFilter" id="dayL√∏rdag" autocomplete="off" data-day="L√∏rdag" /><label class="btn btn-outline-primary" for="dayL√∏rdag">L√∏rdag</label></div></div></div><div class="table-responsive"><table id="eventTable" class="table table-striped table-hover"><thead></thead><tbody></tbody></table></div></div></div>
        <footer class="mt-5 text-center text-muted small"><p>&copy; <span id="currentYear"></span> Folkem√∏det Event Viewer.</p></footer>
    </div>
    
    <!-- Split Modals: details and calendar -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title" id="detailsModalLabel">Event Details</h5><button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button></div>
          <div class="modal-body" id="detailsModalBody"></div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="calendarModal" tabindex="-1" aria-labelledby="calendarModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
          <div class="modal-header">
             <ul class="nav nav-tabs" id="calendarModalTabs" role="tablist">
                <li class="nav-item" role="presentation"><a data-mdb-tab-init class="nav-link active" id="tab-personal" href="#personal-calendar-pane" role="tab" aria-controls="personal-calendar-pane" aria-selected="true">Personal</a></li>
                <li class="nav-item" role="presentation"><a data-mdb-tab-init class="nav-link" id="tab-team" href="#team-calendar-pane" role="tab" aria-controls="team-calendar-pane" aria-selected="false">Team</a></li>
             </ul>
            <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
             <div class="tab-content" id="calendarModalContent">
                <div class="tab-pane fade show active" id="personal-calendar-pane" role="tabpanel" aria-labelledby="tab-personal"></div>
                <div class="tab-pane fade" id="team-calendar-pane" role="tabpanel" aria-labelledby="tab-team"></div>
             </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.2.0/mdb.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <script>
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        const ALL_DATA_HEADERS = ["Favorite", "EventTitle", "Weekday", "TimeRange", "Location", "Description", "EventURL", "Organizers", "Theme", "DataSource", "id"];
        
        $(document).ready(function() {
            let eventDataTable = null, detailsModalInstance, calendarModalInstance, teamsModalInstance, authModalInstance, passwordResetModalInstance;
            let allEvents = [], teamFavorites = new Map(), teamMembers = new Map();
            let favoriteEvents = new Set(), currentUserId = null, currentTeamId = null;
            let unsubscribeFavorites = () => {}, unsubscribeUser = () => {}, unsubscribeTeam = () => {};

            // --- DOM ELEMENT GETTERS ---
            const getEl = (id) => document.getElementById(id);
            const detailsModalBody = getEl('detailsModalBody');
            const personalCalendarPane = getEl('personal-calendar-pane'), teamCalendarPane = getEl('team-calendar-pane');
            const teamButton = getEl('team-button'), calendarButton = getEl('calendar-button');
            const userDisplayName = getEl('user-display-name'), loginNavItem = getEl('login-nav-item'), userNavItem = getEl('user-nav-item');
            
            // --- MODAL INITIALIZATION ---
            detailsModalInstance = new mdb.Modal(getEl('detailsModal'));
            calendarModalInstance = new mdb.Modal(getEl('calendarModal'));
            teamsModalInstance = new mdb.Modal(getEl('teamsModal'));
            authModalInstance = new mdb.Modal(getEl('authModal'));
            passwordResetModalInstance = new mdb.Modal(getEl('passwordResetModal'));

            // --- THEME SWITCHER ---
            // ... (no changes)

            // --- FIREBASE AUTH & DATA LOGIC ---
            async function handleSignup() {
                const { functions, httpsCallable } = window.firebase;
                const authError = getEl('authError');
                authError.style.display = 'none';

                const createNewUser = httpsCallable(functions, 'createNewUser');
                try {
                    const result = await createNewUser({
                        email: getEl('authEmail').value,
                        password: getEl('authPassword').value,
                        inviteCode: getEl('inviteCode').value,
                    });

                    if (result.data.status === 'success') {
                        console.log('User created via function:', result.data.user);
                        authModalInstance.hide();
                    } else {
                         throw new Error(result.data.message || 'An unknown error occurred.');
                    }
                } catch (error) {
                    authError.textContent = error.message;
                    authError.style.display = 'block';
                }
            }

            async function handlePasswordReset() {
                const email = getEl('resetEmail').value;
                const resetError = getEl('resetError');
                const resetSuccess = getEl('resetSuccess');
                resetError.style.display = 'none';
                resetSuccess.style.display = 'none';

                if (!email) {
                    resetError.textContent = "Please enter your email address.";
                    resetError.style.display = 'block';
                    return;
                }
                try {
                    await window.firebase.sendPasswordResetEmail(window.firebase.auth, email);
                    resetSuccess.textContent = "Password reset link sent! Please check your inbox.";
                    resetSuccess.style.display = 'block';
                } catch (error) {
                    resetError.textContent = error.message;
                    resetError.style.display = 'block';
                }
            }
            
            // ... other firebase functions (toggleFavorite, createTeam, etc.) are the same ...

            function setupAuthListener() {
                 if (!window.firebase) { setTimeout(setupAuthListener, 100); return; }
                const { auth, onAuthStateChanged, db, doc, onSnapshot, setDoc, collection } = window.firebase;
                onAuthStateChanged(auth, (user) => {
                    unsubscribeFavorites(); unsubscribeUser(); unsubscribeTeam();
                    teamFavorites.clear(); teamMembers.clear();
                    if (user) {
                        currentUserId = user.uid;
                        const userRef = doc(db, 'users', currentUserId);
                        const userName = user.displayName || user.email.split('@')[0];
                        setDoc(userRef, { name: userName, email: user.email }, { merge: true });

                        userDisplayName.textContent = userName;
                        getEl('user-status').textContent = user.email;
                        loginNavItem.style.display = 'none';
                        userNavItem.style.display = 'block';

                        unsubscribeUser = onSnapshot(userRef, (doc) => {
                            currentTeamId = doc.data()?.teamId || null;
                            listenToTeamChanges(); 
                        });

                        const favsRef = collection(db, "users", currentUserId, "favorites");
                        unsubscribeFavorites = onSnapshot(favsRef, (snapshot) => {
                            favoriteEvents.clear();
                            snapshot.forEach(doc => favoriteEvents.add(doc.id));
                            if (eventDataTable) eventDataTable.rows().invalidate('data').draw(false);
                        });

                        loadEvents(); // Load events from cache or Firestore
                    } else {
                        currentUserId = null; currentTeamId = null;
                        favoriteEvents.clear(); allEvents = [];
                        loginNavItem.style.display = 'block'; userNavItem.style.display = 'none';
                        if (eventDataTable) { eventDataTable.clear().draw(); }
                        getEl('dataFreshness').textContent = "Please log in to view event data.";
                    }
                });
            }

            // ... listenToTeamChanges, loadEvents, initializeDataTable are the same ...
            
            // --- UI RENDER & EVENT LISTENERS ---
            setupAuthListener();
            getEl('login-button').addEventListener('click', () => authModalInstance.show());
            getEl('authSignUpButton').addEventListener('click', handleSignup);
            getEl('authLoginButton').addEventListener('click', () => { /* ... */ });
            getEl('googleLoginButton').addEventListener('click', () => { /* ... */ });
            getEl('logout-button').addEventListener('click', () => { if (window.firebase) window.firebase.signOut(window.firebase.auth); });
            getEl('forgot-password-link').addEventListener('click', () => {
                authModalInstance.hide();
                passwordResetModalInstance.show();
            });
            getEl('resetPasswordButton').addEventListener('click', handlePasswordReset);
            getEl('reset-password-menu-item').addEventListener('click', () => {
                getEl('resetEmail').value = window.firebase.auth.currentUser?.email || '';
                passwordResetModalInstance.show();
            });


            teamButton.addEventListener('click', () => {
                if(currentUserId) {
                    teamsModalInstance.show();
                } else {
                    authModalInstance.show();
                }
            });

            calendarButton.addEventListener('click', () => {
                if(currentUserId) {
                    renderPersonalCalendar();
                    renderTeamCalendar();
                    calendarModalInstance.show();
                } else {
                    authModalInstance.show();
                }
            });

            // ... other listeners (team modal, filters) ...

            $('#eventTable tbody').on('click', 'tr', function () {
                const rowData = eventDataTable.row(this).data();
                if (!rowData) return;
                renderDetailsView(rowData);
                detailsModalInstance.show(); // Show the dedicated details modal
            });
            
            $('#eventTable tbody').on('click', '.favorite-icon', function (e) {
                e.stopPropagation();
                if(!currentUserId) { authModalInstance.show(); return; }
                const eventId = $(this).data('event-id');
                const isFavorited = favoriteEvents.has(eventId);
                toggleFavorite(eventId, isFavorited);
            });

            function renderDetailsView(rowData) {
                // ... same as before, but populates #detailsModalBody ...
                const colIdx = {}; ALL_DATA_HEADERS.forEach((h, i) => colIdx[h] = i);
                const eventData = {}; ALL_DATA_HEADERS.forEach(header => { eventData[header] = rowData[colIdx[header]]; });
                
                let modalHtml = `<h5 class="mb-3">${eventData.EventTitle}</h5><ul class="list-group list-group-flush">`;
                const modalDisplayOrder = [ { key: 'Description', label: 'Description' }, { key: 'Weekday', label: 'Day' }, { key: 'TimeRange', label: 'Time' }, { key: 'Location', label: 'Location' }, { key: 'Organizers', label: 'Organizers' }, { key: 'Theme', label: 'Theme' }, { key: 'EventURL', label: 'Link' }, { key: 'DataSource', label: 'Source' } ];
                
                modalDisplayOrder.forEach(item => {
                    const value = eventData[item.key];
                    if (value) {
                        if (item.key === 'EventURL' && value.startsWith('http')) {
                            modalHtml += `<li class="list-group-item"><p class="text-muted mb-1 small">${item.label}</p><a href="${value}" target="_blank" rel="noopener noreferrer">View Original Event</a></li>`;
                        } else {
                            modalHtml += `<li class="list-group-item"><p class="text-muted mb-1 small">${item.label}</p><p class="mb-0">${value}</p></li>`;
                        }
                    }
                });

                modalHtml += `</ul>`;
                detailsModalBody.innerHTML = modalHtml;
            }

            function renderPersonalCalendar() {
                const personalFavs = allEvents.filter(e => favoriteEvents.has(e.id));
                if (personalFavs.length === 0) {
                    personalCalendarPane.innerHTML = `<p class="text-center text-muted mt-4">You haven't added any events to your calendar yet. Click the <i class="far fa-heart"></i> icon on an event to add it.</p>`;
                    return;
                }
                personalCalendarPane.innerHTML = buildCalendarTimeline(personalFavs);
            }

            function renderTeamCalendar() {
                if (!currentTeamId) {
                    teamCalendarPane.innerHTML = `<p class="text-center text-muted mt-4">You are not in a team. Join or create one via the "My Team" button.</p>`;
                    return;
                }
                
                const allTeamFavs = new Map();
                teamFavorites.forEach((favs, userId) => {
                    const userName = teamMembers.get(userId) || 'Unknown';
                    favs.forEach(eventId => {
                        const event = allEvents.find(e => e.id === eventId);
                        if (event) {
                            if (!allTeamFavs.has(eventId)) {
                                allTeamFavs.set(eventId, { event, users: [] });
                            }
                            allTeamFavs.get(eventId).users.push({id: userId, name: userName});
                        }
                    });
                });

                if (allTeamFavs.size === 0) {
                    teamCalendarPane.innerHTML = `<p class="text-center text-muted mt-4">Your team calendar is empty.</p>`;
                    return;
                }
                
                teamCalendarPane.innerHTML = buildCalendarTimeline(Array.from(allTeamFavs.values()));
            }

            function buildCalendarTimeline(eventsData) {
                 const eventsByDay = eventsData.reduce((acc, data) => {
                    const event = data.event || data; // Handle both personal and team data structure
                    if (!acc[event.Weekday]) acc[event.Weekday] = [];
                    acc[event.Weekday].push(data);
                    return acc;
                }, {});

                let calendarHtml = '<div class="timeline-container">';
                ["Onsdag", "Torsdag", "Fredag", "L√∏rdag"].forEach(day => {
                    if (eventsByDay[day]) {
                        calendarHtml += `<div class="timeline-day"><h4>${day}</h4><div class="timeline-grid">`;
                        for (let hour = 8; hour <= 23; hour++) {
                            const top = (hour - 8) * 60;
                            calendarHtml += `<div class="time-label" style="top: ${top - 10}px;">${String(hour).padStart(2, '0')}:00</div>`;
                            calendarHtml += `<div class="time-line" style="top: ${top}px;"></div>`;
                        }

                        const placedEvents = [];
                        eventsByDay[day].sort((a,b) => ((a.event||a).TimeRange || "").localeCompare((b.event||b).TimeRange || "")).forEach((data) => {
                            const event = data.event || data;
                            const users = data.users || [{id: currentUserId, name: 'You'}];
                            
                            const timeParts = (event.TimeRange || "00:00-00:00").split('-');
                            const start = timeParts[0].split(':');
                            const end = timeParts.length > 1 ? timeParts[1].split(':') : start;
                            
                            const startMinutes = (parseInt(start[0], 10) * 60) + parseInt(start[1], 10);
                            const endMinutes = (parseInt(end[0], 10) * 60) + parseInt(end[1], 10);
                            const duration = Math.max(30, endMinutes - startMinutes);
                            
                            const top = (startMinutes - (8 * 60));
                            const height = duration;
                            
                            let eventClass = 'timeline-event';
                            if (!users.find(u => u.id === currentUserId)) {
                               eventClass += ' teammate';
                            }
                            const userHtml = users.map(u => u.name).join(', ');

                            let column = 0;
                            while(placedEvents.some(p => p.column === column && top < p.end && (top + height) > p.top)) {
                                column++;
                            }
                            placedEvents.push({top, end: top + height, column});
                            const left = 65 + (column * 155);

                            calendarHtml += `<div class="${eventClass}" style="top: ${top}px; height: ${height}px; width: 150px; left: ${left}px;" title="${event.EventTitle} - ${userHtml}"><strong>${event.EventTitle}</strong><br><small><i>${userHtml}</i></small></div>`;
                        });
                        calendarHtml += `</div></div>`;
                    }
                });
                calendarHtml += `</div>`;
                return calendarHtml;
            }

            // ... other functions (updateTeamViewUI, updateVisualizations) ...
        });
    </script>
</body>
</html>
